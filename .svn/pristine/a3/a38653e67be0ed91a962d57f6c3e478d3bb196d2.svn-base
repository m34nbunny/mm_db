package com.m_mb.mm.ws;

import java.lang.annotation.Annotation;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

import org.ksoap2.serialization.SoapObject;
import org.ksoap2.serialization.SoapPrimitive;
import org.ksoap2.serialization.SoapSerializationEnvelope;

import com.m_mb.mm.DataMember;

public class WS {
	
	private static void SetInt(Object object, Object value, Field field) {
		try {
			Integer intValue = Integer.parseInt(value.toString());
			field.set(object, intValue);
		} catch (Exception e) {
			System.out.println(e.getMessage());
		}
	}
	
	private static void SetString(Object object, Object value, Field field) {
		try {
			field.set(object, value);
		} catch (Exception e) {
			System.out.println(e.getMessage());
		}
	}
	
	private static List<Field> GetDMFieldsOnly(Field[] sFields) {
		List<Field> list = new ArrayList<Field>();
		for (Field field : sFields) {
			Annotation[] annotations = field.getDeclaredAnnotations();
			boolean isDataParameter = false;
			for (Annotation a : annotations) {
				if (a instanceof DataMember)
					isDataParameter = true;
			}
			if (isDataParameter)
				list.add(field);
		}
		return list; 
	}
	
	private static <T> void SetFields(Field field, SoapObject result, T nObj) {
		String fieldName = field.getName();
		if (result.hasProperty(fieldName)) {
			String value = result.getPropertyAsString(fieldName);
			Class<?> fieldType = field.getType();
			if (fieldType == String.class) {
				SetString(nObj, value, field);	
			} else if (fieldType == int.class) {
				SetInt(nObj,  value, field);
			}	
		}
	}
		
	public static <T> SoapObject CreateSoapObject(String ns, T data) throws Exception {
		SoapObject item = new SoapObject(ns, data.getClass().getName());
		Field[] fields = data.getClass().getFields();
		for (Field field : fields) {
			item.addProperty(field.getName(), field.get(data));
		}
		return item;
	}
	
	@SuppressWarnings("unchecked")
	public static <T> T ReadSimple(Class<T> type, SoapSerializationEnvelope envelope) throws Exception {
		Object obj = envelope.getResponse();
		SoapPrimitive result = (SoapPrimitive)obj;
		return (T)result.getValue();
	}
	
	public static <T> T Read(Class<T> type, SoapSerializationEnvelope envelope) throws Exception {
		Object obj = envelope.getResponse();
		List<Field> objFields = GetDMFieldsOnly(type.getFields());
		SoapObject result = (SoapObject)obj;
		T nObj = type.newInstance();
		for (Field field : objFields) {
			SetFields(field, result, nObj);
		}
		return nObj;
	}
	
	@SuppressWarnings({ "unchecked" })
	public static <T> List<T> ReadCollection(Class<T> type, SoapSerializationEnvelope envelope) throws Exception {
		Object obj = envelope.getResponse();
		List<T> tList = new ArrayList<T>();
		List<Field> objFields = GetDMFieldsOnly(type.getFields());
		if (obj.getClass() == Vector.class) {
			Vector<SoapObject> collection = (Vector<SoapObject>)obj;
			for (SoapObject result : collection) {
				T nObj = type.newInstance();
				for (Field field : objFields) {
					SetFields(field, result, nObj);
					tList.add(nObj);
				}
			}
		} else {
			SoapObject result = (SoapObject)obj;
			T nObj = type.newInstance();
			for (Field field : objFields) {
				SetFields(field, result, nObj);
			}
			tList.add(nObj);
		}
		return tList;
	}
}
